#!/bin/sh

# based on https://github.com/mengqiy/kubernetes/blob/master/examples/https-nginx/auto-reload-nginx.sh

set -u
watchpath="${1}"  # eg: /etc/dnsmasq.d/
cmd="${2}"        # eg: s6-svc -t /services/dnsmasq/

oldcksum=$(cksum ${watchpath}*)

inotifywait -e modify,move,create,delete -mr --timefmt '%Y-%m-%dT%H:%M:%S' --format '%T' ${watchpath} | while read datetime; do
    newcksum=$(cksum ${watchpath}*)
    if [ "${newcksum}" != "${oldcksum}" ]; then
        echo "Got new config at ${datetime}, running: ${cmd}"
        oldcksum=${newcksum}
        ${cmd}
    fi
done
